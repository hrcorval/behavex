<?xml version="1.0" encoding="UTF-8"?>
{#
/*
* BehaveX - Agile test wrapper on top of Behave (BDD)
*/#}


{%- macro print_step_xml(step) -%}
    {%- if step.table -%}
        {{ 20*' ' }}
        {%- for key in step.table.headings -%}
            |{{ key }}
        {%- endfor -%}
        {{'\n'}}
        {%- for values in step.table.rows -%}
            {{ 20*' ' }}
            {%- for value in values-%}
                |{{ value }}
            {%- endfor -%}
            {{'\n'}}
        {%- endfor -%}
    {%- endif -%}
        {{ 16*' ' ~ step|print_step|safe ~ '\n'}}
{%- endmacro -%}
{%- macro print_scenario(scenario) -%}
{%- set scenario_tags = scenario|get_scenario_tags-%}
{%- set is_muted = ('MUTE' in scenario_tags and scenario.status == 'failed')-%}
{%- set errors_step = 0-%}
        {%- for step in scenario.steps -%}
            {%- set errors_step = errors_step + (0 if step.error_message else 1) -%}
        {%- endfor -%}
        <testcase time="{{ scenario.duration }}" name={{scenario.name|normalize|CIXC|quoteattr|safe}} status="{{ scenario.status if not is_muted else 'skipped'}}"
         classname={{scenario.feature.name|normalize|CIXC|quoteattr|safe }}>
            {%- set steps_with_exception = scenario.steps|get_list_exception_steps(scenario._background_steps) -%}
            {%- set scenario_crashed = True if (scenario.status == 'failed' and steps_with_exception|length == 0) else False -%}
            {%- if scenario_crashed and not is_muted -%}
                <failure type=Exception message={{scenario.error_msg|get_error_message|CIXC|quoteattr|safe }}>
                    <![CDATA[ {{ scenario.error_msg }} ]]>
                </failure>
            {%- elif steps_with_exception and not is_muted -%}
                {%- for step in steps_with_exception -%}
                    <failure type={{ step|get_exception_class_name|normalize|CIXC|quoteattr|safe}} message={{ step|get_exception_message|get_error_message|CIXC|quoteattr|safe}}>
                        <![CDATA[ Failing step: {{step|print_step|safe}} Location:{{step.filename|normalize|safe}}
                         {{step|get_lines_exception|safe}}
                        ]]>
                    </failure>
                {%- endfor -%}
            {%- endif -%}
            <system-out>
            <![CDATA[
            @scenario.begin
                {{ (scenario_tags)|print_tag_xml}}
                scenario: {{ scenario.name|CIXC|safe ~'\n'}}
                {%- if scenario._background_steps is iterable -%}
                    {%- for step in scenario._background_steps -%}
                        {{ print_step_xml(step)|safe}}
                    {%- endfor -%}
                {%- endif -%}
                {%- for step in scenario.steps -%}
                    {{ print_step_xml(step)|safe }}
                {%- endfor -%}
            @scenario.end
            ----------------------------------------------------------------------------------------------------
            ]]>
            </system-out>
        </testcase>
{%- endmacro -%}
<testsuite time="{{ summary.time }}" tests='{{ scenarios|count }}' skipped='{{ summary.skipped }}'
name={{ feature.filename[9:-8]|normalize|CIXC|quoteattr|safe }} failures='{{ summary.failures }}' errors='0'>
{%- for scenario in scenarios -%}
    {%- if scenario._scenarios is defined -%}
        {%- for _scenario in scenario._scenarios -%}
            {{ print_scenario(_scenario)|safe }}
        {%- endfor -%}
    {%- else -%}
        {{ print_scenario(scenario)|safe }}
    {%- endif -%}
{%- endfor -%}
</testsuite>
